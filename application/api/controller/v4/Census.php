<?php
    /**
     *  数据统计 - v3
     *  Encoding : UTF-8
     *  Separator : Unix and OS X (\n)
     *  File Name : Task.php
     *  Create Date : 2022/10/23 10:32
     *  Version : 0.1
     *  Copyright : skylong Project Team Copyright (C)
     *  license http://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh
     */
    namespace app\api\controller\v4;
    use app\common\controller\WeChatFactory;
    use think\Exception;

    class Census extends WeChatFactory {

        private $info   = [];
        private $openid = '';
        private $type = 1;
        private $webUrl = '';
        public function initialize() {
            parent::initialize(); // TODO: Change the autogenerated stub
            $this->openid = $this->request->param('openid');
            $this->webUrl = config('sys_data.web_site');
            $this->type = $this->request->param('type',self::TEACHER_SCHOOL);
            $info         = db('teacher')->where("openid = '{$this->openid}' and type = {$this->type}")->find();
            if (!empty($info)) {
                $this->info        = $info;
            }
        }

        // 查看轻任务列表
        public function task_list(){
            $page  = $this->request->param('page', 1);
            $limit = $this->request->param('limit', 10);

            $list = db('type_task_table')
                ->alias('ttt')
                ->join('task t','t.id = ttt.tasked_id')
                ->join("task_index ti",'ti.task_id = t.id','left')
                ->join("subject su",'su.id = ti.subject_id','left')
                ->join('type_task_log_table ttlt','ttt.id = ttlt.type_task_id')
                ->where('ttt.type',self::TYPE_SOFT)
                ->where('ttt.admin_id',$this->info['id'])
                ->where('ttlt.is_cancel',self::DEFAULT_NO)
                ->limit(($page-1)*$limit,$limit)
                ->field("t.id task_id,ttt.id,ttt.`mode`,if(instr(t.image,'http')>0,t.image,concat('{$this->webUrl}',t.image)) image,t.`name`,su.`name` subject_name,ti.`level`,if(ti.level is null,\"无\",if(ti.`level` = 1,\"A\",if(ti.`level` = 2,\"B\",\"C\"))) level_name,t.`desc`,t.type,FROM_UNIXTIME(ttt.start_date,\"%Y-%m-%d\") start_date,ttt.difficulty_points,ttt.status")
                ->select();

            $total = db('type_task_table')
                ->alias('ttt')
                ->join('type_task_log_table ttlt','ttt.id = ttlt.type_task_id')
                ->where('ttt.type',self::TYPE_SOFT)
                ->where('ttt.admin_id',$this->info['id'])
                ->where('ttlt.is_cancel',self::DEFAULT_NO)
                ->count();
            return $this->returnJson(['list'=>$list,'currentPage' => $page,'totalPage' => ceil($total/$limit)],'获取成功',1);
        }


    }