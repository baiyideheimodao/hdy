<?php
    /**
     *  Encoding : UTF-8
     *  Separator : Unix and OS X (\n)
     *  File Name : Courseindex.php
     *  Create Date : 2022/6/20 22:06
     *  Version : 0.1
     *  Copyright : double_teachers_online Project Team Copyright (C)
     *  license http://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh
     */
    namespace app\admin\controller;
    use app\common\controller\AdminController;

    class Courseindex extends AdminController {

        public function initialize() {
            parent::initialize(); // TODO: Change the autogenerated stub
        }

        private function getList($level = 0){
            $page = $this->request->post('page', $this->page);
            $limit = $this->request->post('limit', $this->limit);
            $list = db('course_index')
                ->alias('ci')
                ->join('course_index cii','ci.pid = cii.id','left')
                ->field('ci.*,ifnull(cii.`name`,"-") p_name')
                ->where("ci.level = {$level}")
                ->limit(($page - 1) * $limit, $limit)
                ->select();
            $total = db('course_index')
                ->alias('ci')
                ->join('course_index cii','ci.pid = cii.id','left')
                ->where("ci.level = {$level}")
                ->count();
            return $this->returnTabelJson($list, '查询成功', $total);
        }

        private function add($level = 0){
            $name = $this->request->param('name','');
            $sort = $this->request->param('sort',100);
            $pid = $this->request->param('pid',0);

            $res =  db('course_index')->insertGetId([
                'name' => $name,
                'sort' => $sort,
                'pid' => $pid,
                'level' => $level
            ]);
            return $this->returnJson([], '添加成功',1);
        }

        public function one(){
            $type = 1;
            if($this->request->isPost()){
                return $this->getList($type);
            }
            $url = '/admin/Courseindex/one';
            return $this->fetch('index',compact('url','type'));
        }

        public function two(){
            $type = 2;
            if($this->request->isPost()){
                return $this->getList($type);
            }
            $url = '/admin/Courseindex/two';
            return $this->fetch('index',compact('url','type'));
        }

        public function addOne(){
            $type = 1;
            if($this->request->isPost()){
                return $this->add($type);
            }
            $pList = [];
            $url = '/admin/Courseindex/addOne';
            return $this->fetch('save',compact('type','pList','url'));
        }

        public function addTwo(){
            $type = 2;
            if($this->request->isPost()){
                return $this->add($type);
            }
            $pList = db('course_index')->where("level = 1 and status = 1")->select();
            $url = '/admin/Courseindex/addTwo';
            return $this->fetch('save',compact('type','pList','url'));
        }

        public function edit(){
            if($this->request->isPost()){
                $params = $this->request->param();
                $upt = [];
                if(isset($params['pid'])){
                    $upt['pid'] = $params['pid'];
                }
                if(isset($params['name'])){
                    $upt['name'] = $params['name'];
                }
                if(isset($params['sort'])){
                    $upt['sort'] = $params['sort'];
                }
                if(isset($params['status'])){
                    $upt['status'] = $params['status'];
                }
                if(empty($upt)){
                    return $this->returnJson([], '更新成功',1);
                }
                db('course_index')->where("id = {$params['id']}")->update($upt);
                return $this->returnJson([], '更新成功',1);
            }
            $id = $this->request->param('id',0);
            $info = db('course_index')
                ->where("id = {$id}")
                ->find();
            $url = '/admin/Courseindex/edit';
            $type = $info['level'];
            $level = $type - 1;
            $pList = db('course_index')->where("level = {$level} and status = 1")->select();
            return $this->fetch('save',compact('type','info','url','pList'));
        }

        public function del() {
            $params = request()->param();
            if (!isset($params['id'])) {
                return showData(0, 'ID不存在');
            }
            // 判断删除用户下是否存在客户
            if(db('task')->where("sub_course_index_id = ({$params['id']})")->count() > 0 || db('question')->where("sub_course_index_id = ({$params['id']})")->count() > 0){
                return showData(0,'当前类型下存在任务或者题目，请删除后再尝试');
            }else{
                db('course_index')->where("id = ({$params['id']})")->delete();
                return showData(200, '操作成功');
            }
            
        }
    }