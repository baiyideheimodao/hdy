<?php
    /**
     *  Encoding : UTF-8
     *  Separator : Unix and OS X (\n)
     *  File Name : Teacher.php
     *  Create Date : 2022/7/9 21:25
     *  Version : 0.1
     *  Copyright : skylong Project Team Copyright (C)
     *  license http://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh
     */
    namespace app\admin\controller\v2;
    use app\common\controller\AdminController;

    class Teacher extends AdminController {

        public function initialize() {
            parent::initialize(); // TODO: Change the autogenerated stub
        }

        public function index(){
            if ($this->request->isPost()) {
                $page = $this->request->post('page', $this->page);
                $limit = $this->request->post('limit', $this->limit);
                $list = db('teacher')
                    ->alias('t')
                    ->join('class_group cg', 't.class_id = cg.id','left')
                    ->join('school s', 's.id = t.school_id and s.state =' . $this->status['NORMAL'],'left')
                    ->join('base b', 'b.id = t.base_id and b.state =' . $this->status['NORMAL'],'left')
                    ->field('t.id,t.username,t.is_head,if(t.type=1,"学校教师","基地教师") type_name,t.type,s.`name` school_name,b.`name` base_name,t.status,cg.name cla_name')
                    ->limit(($page - 1) * $limit, $limit)
                    ->select();
                $total = db('teacher')
                    ->alias('t')
                    ->count();
                return $this->returnTabelJson($list, '查询成功', $total);
            }
            return $this->fetch();
        }

        public function add(){
            if ($this->request->isPost()) {
                $username = $this->request->param('username','');
                $password = $this->request->param('password','111111');
                $sex = $this->request->param('sex',0);
                $phone = $this->request->param('phone','');
                $type = $this->request->param('type',0);
                $base_id = $this->request->param('base_id',0);
                $school_id = $this->request->param('school_id',0);
                $class_id = $this->request->param('class_id',0);
                $is_head = $this->request->param('is_head',0);
                $status = $this->request->param('status',0);

                $id = db('teacher')->insertGetId([
                    'username' => $username,
                    'password' => md5($password),
                    'sex' => $sex,
                    'phone' => $phone,
                    'type' => $type,
                    'status' => $status,
                    'create_time' => time(),
                    'admin_id' => cookie('id'),
                    'class_id' => $class_id,
                    'school_id' => str_replace('s','',$school_id),
                    'base_id' => str_replace('b','',$base_id),
                    'is_head' => $is_head
                ]);
                if ($id > 0) {
                    insert_admin_log('创建教师成功');
                    return $this->returnJson(['id' => $id], '创建教师成功', 1);
                }
                return $this->returnJson([], '创建教师失败');
            }
            return $this->fetch('save');
        }

        public function edit(){
            $id = $this->request->param('id',0);
            if ($this->request->isPost()) {
                $username = $this->request->param('username','');
                $password = $this->request->param('password','');
                $sex = $this->request->param('sex',0);
                $phone = $this->request->param('phone','');
                $type = $this->request->param('type',0);
                $base_id = $this->request->param('base_id',0);
                $school_id = $this->request->param('school_id',0);
                $class_id = $this->request->param('class_id',0);
                $is_head = $this->request->param('is_head',0);
                $status = $this->request->param('status',0);

                $update = [
                    'username' => $username,
                    'sex' => $sex,
                    'phone' => $phone,
                    'type' => $type,
                    'status' => $status,
                    'class_id' => $class_id,
                    'school_id' => str_replace('s','',$school_id),
                    'base_id' => str_replace('b','',$base_id),
                    'is_head' => $is_head
                ];
                if(!empty($password)){
                    $update['password'] = md5($password);
                }
                $id = db('teacher')->where('id',$id)->update($update);
                if ($id !== false) {
                    insert_admin_log('更新教师成功');
                    return $this->returnJson(['id' => $id], '操作成功', 1);
                }
                return $this->returnJson([], '操作失败');
            }
            $info = db('teacher')
                ->alias('t')
                ->join('class_group s','t.class_id = s.id','left')
                ->join('base b','t.base_id = b.id','left')
                ->where("t.id",$id)
                ->field('t.*,s.`name` class_name,b.`name` base_name')
                ->find();
            $url = '/admin/v2.teacher/edit';
            return $this->fetch('save',compact('info','url'));
        }

        public function del(){
            $id = $this->request->param('id', 0);
            db('teacher')->where("id = {$id}")->delete();
            return $this->returnJson([], '操作成功');
        }


        public function state(){
            $id = $this->request->param('id', 0);
            $status = $this->request->param('status', 0);
            db('teacher')->where("id = {$id}")->update(['status'=>$status]);
            return $this->returnJson([], '操作成功');
        }

        public function is_head(){
            $id = $this->request->param('id', 0);
            $is_head = $this->request->param('is_head', 0);
            db('teacher')->where("id = {$id}")->update(['is_head'=>$is_head]);
            return $this->returnJson([], '操作成功');
        }
    }