<?php
    namespace app\admin\controller;

    use app\common\controller\AdminController;
    use think\Db;
    use \think\facade\Cookie;

    class System extends AdminController {
        public function initialize() {
            parent::initialize(); // TODO: Change the autogenerated stub
        }

        public function index($type = 1) {
            if($this->request->isPost()){
                $page = $this->request->post('page',$this->page);
                $limit = $this->request->post('limit',$this->limit);
                $list = db('system')
                    ->limit(($page-1)*$limit,$limit)
                    ->select();
                $total = db('system')
                    ->count();
                return $this->returnTabelJson($list,'查询成功',$total);
            }
            return $this->fetch();
        }

        public function edit($id) {
            $data = ($this->request->param());
            if (@$data['action']) {
                unset($data['action']);
                if(isset($data['file'])){
                    unset($data['file']);
                }
                Db::name('system')->where('id', $data['id'])->data($data)->update();
                clear_cache();
                return 1;
            }
            $data = Db::name('system')->where('id', $id)->find();
            $this->assign('data', $data);
            return $this->fetch();
        }

        public function del($id) {
            Db::name('system')->where('id', $id)->delete();
            return 1;
        }

        public function add() {
            $data = ($this->request->param());
            if (@$data['action']) {
                unset($data['action']);
                $res = Db::name('system')->data($data)->insert();
                if ($res) {
                    clear_cache();
                    return 1;
                } else {
                    return 0;
                }
            }
            return $this->fetch();
        }

        public function sort(){
            $data = ($this->request->post());
            $data= json_decode(html_entity_decode(stripslashes($data['sortData'])), true);
            foreach ($data as $k => $val){
                db('system')->data(['sort'=>$val['sort']])->where('id',$val['id'])->update();
            }
            return 1;
        }

        public function home() {
            return $this->fetch('home/index');
        }
    }
