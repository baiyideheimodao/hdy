<?php
    /**
     *  Encoding : UTF-8
     *  Separator : Unix and OS X (\n)
     *  File Name : Banner.php
     *  Create Date : 2022/1/6 19:38
     *  Version : 0.1
     *  Copyright : skylong Project Team Copyright (C)
     *  license http://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh
     */
    namespace app\admin\controller;
    use app\common\controller\AdminController;

    class Banner extends AdminController {

        public function initialize() {
            parent::initialize(); // TODO: Change the autogenerated stub
        }

        public function index(){
            if($this->request->isPost()){
                $where = [];
                if((int)cookie('group_id') !== config('rx.groupId')){
                    $where['b.admin_id'] = cookie('id');
                }
                $page = $this->request->post('page',$this->page);
                $limit = $this->request->post('limit',$this->limit);
                $list = db('banner')
                    ->alias('b')
                    ->join('area a','b.area_id = a.id','left')
                    ->field('b.id,b.image,b.url,b.type,b.link_type,b.name,b.state,b.sort,a.name area_name,b.area_id')
                    ->where($where)
                    ->limit(($page-1)*$limit,$limit)
                    ->order('b.area_id,b.sort,b.state desc')
                    ->select();
                $total = db('banner')
                    ->alias('b')
                    ->count();
                return $this->returnTabelJson($list,'查询成功',$total);
            }
            return $this->fetch();
        }

        public function add(){
            if($this->request->isPost()){
                $type = $this->request->param('type',1);
                $name = $this->request->param('name','');
                $url = $this->request->param('url','');
                $image = $this->request->param('image','');
                $sort = $this->request->param('sort',0);
                $link_type = $this->request->param('link_type',0);
                if(empty($image)){
                    return $this->returnJson([],'广告图片不能为空');
                }
                $insert = [
                  'type' => $type,
                  'link_type' => $link_type,
                  'name' => $name,
                  'url' => $url,
                  'image' => $image,
                  'sort' => $sort
                ];
                $id = db('banner')->insertGetId($insert);
                if($id > 0){
                    insert_admin_log('广告创建成功');
                    return $this->returnJson(['id'=>$id],'操作成功',1);
                }
                return $this->returnJson([],'操作失败');
            }
            return $this->fetch('save');
        }

        public function edit(){
            $id = $this->request->param('id',0);
            if($this->request->isPost()){
                $data = $this->request->param();
                $update = [];
                if(isset($data['state'])){
                    $update['state'] = $data['state'];
                }
                if(isset($data['type'])){
                    $update['type'] = $data['type'];
                }
                if(isset($data['link_type'])){
                    $update['link_type'] = $data['link_type'];
                }
                if(isset($data['name'])){
                    $update['name'] = $data['name'];
                }
                if(isset($data['url'])){
                    $update['url'] = $data['url'];
                }
                if(isset($data['image'])){
                    $update['image'] = $data['image'];
                }
                if(isset($data['sort'])){
                    $update['sort'] = $data['sort'];
                }
                if(empty($update)){
                    return $this->returnJson([],'操作失败');
                }
                $res = db('banner')->where("id = {$id}")->update($update);
                if($res !== false){
                    insert_admin_log('广告更新成功');
                    return $this->returnJson(['id'=>$id],'操作成功',1);
                }
                return $this->returnJson([],'操作失败');
            }
            $info = db('banner')->where("id = {$id}")->find();
            $info['urls'] = '/admin/banner/edit';
            return $this->fetch('save',compact('info'));
        }
    }